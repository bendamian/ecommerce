{% extends "base.html" %}
{% load static %}
{% load mathfilters %}

{# ============================= #}
{#            CSS                #}
{# ============================= #}
{% block extra_css %}
<style>
  main {
    background-color: #f9fafb;
    min-height: 100vh;
  }

  .product-item {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .product-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  h1, h2, .fw-bold { color: #333; }

  .btn-sm { border-radius: 20px; }

  #total { color: #0d6efd; }
</style>
{% endblock %}

{# ============================= #}
{#           CONTENT             #}
{# ============================= #}
{% block content %}
<main class="pt-5">
  <div class="container" id="cart-container">

    <h1 class="h5 mb-3">Shopping Cart</h1>
    <hr>

    {% for item in cart %}
      {% with product=item.product %}
      <div class="row mb-4 border rounded product-item py-3 shadow-sm" id="cart-item-{{ product.id }}">

        <div class="col-md-3 col-lg-2 bg-light d-flex align-items-center justify-content-center">
          <img
            src="{{ product.image.url|default:'/static/images/placeholder.png' }}"
            alt="{{ product.name }}"
            class="img-fluid rounded"
            width="200"
          >
        </div>

        <div class="col-md-9 col-lg-10 ps-md-4">
          <a href="{{ product.get_absolute_url }}"
             class="link-dark link-offset-2 link-underline-opacity-0 link-underline-opacity-75-hover fw-semibold">
            <h2 class="h6 pt-2 mb-2">{{ product.name }}</h2>
          </a>

          <div class="border rounded-3 overflow-hidden">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
              <span>Price</span>
              <span class="fw-bold h6 mb-0 item-subtotal">
                ${{ product.price|mul:item.quantity|floatformat:2 }}
              </span>
            </div>

            <div class="p-4">
              <label for="select{{ product.id }}" class="form-label mb-1">Qty:</label>

              <select id="select{{ product.id }}" class="form-select form-select-sm d-inline-block w-auto">
                <option value="{{ item.quantity }}" selected>{{ item.quantity }}</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
              </select>

              <div class="mt-3">
                <button type="button"
                        data-index="{{ product.id }}"
                        class="btn btn-primary btn-sm me-2 btn-update">
                  Update
                </button>

                <button type="button"
                        data-index="{{ product.id }}"
                        class="btn btn-danger btn-sm btn-delete">
                  Delete
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% empty %}
      <p id="empty-cart-msg" class="text-muted">Your cart is empty.</p>
    {% endfor %}

    <hr>

    <div class="text-end mt-4">
      <div class="h6 fw-bold">
        Subtotal: $<span id="total">{{ cart.get_total_price|floatformat:2 }}</span>
      </div>
    </div>

    <div class="text-end mb-5 mt-3">
      <a href="{% url 'payment_app:checkout' %}" class="btn btn-lg btn-success" id="checkout-link">
        Proceed to Checkout
      </a>
    </div>

  </div>
</main>
{% endblock content %}

{# ============================= #}
{#             JS                #}
{# ============================= #}
{% block extra_js %}
<script>
  function handleEmptyCart(quantity) {
    const qty = parseInt(quantity, 10);

    if (qty !== 0) {
      $("#empty-cart-msg").remove();
      $("#checkout-link")
        .removeClass("disabled")
        .removeAttr("aria-disabled")
        .removeAttr("tabindex");
      return;
    }

    if (!$("#empty-cart-msg").length) {
      $("#cart-container").append(
        '<p id="empty-cart-msg" class="text-muted mt-3">Your cart is empty.</p>'
      );
    }

    // Disable checkout link (<a>)
    $("#checkout-link")
      .addClass("disabled")
      .attr("aria-disabled", "true")
      .attr("tabindex", "-1");
  }

  // Delete Item
  $(document).on("click", ".btn-delete", function (e) {
    e.preventDefault();

    const productId = $(this).data("index");

    $.ajax({
      type: "POST",
      url: '{% url "cart_app:cart_remove" %}',
      data: {
        productid: productId,
        csrfmiddlewaretoken: "{{ csrf_token }}",
        action: "post",
      },
      success: function (json) {
        $("#cart-item-" + productId).remove();

        $("#cart-quantity").text(json.quantity);
        $("#total").text(json.total);

        handleEmptyCart(json.quantity);
      },
      error: function (xhr) {
        console.error("Error:", xhr.responseText);
      },
    });
  });

  // Update Quantity
  $(document).on("click", ".btn-update", function (e) {
    e.preventDefault();

    const productId = $(this).data("index");
    const qty = $("#select" + productId).val();

    $.ajax({
      type: "POST",
      url: '{% url "cart_app:cart_update" %}',
      data: {
        productid: productId,
        quantity: qty,
        csrfmiddlewaretoken: "{{ csrf_token }}",
        action: "post",
      },
      success: function (json) {
        $("#cart-quantity").text(json.quantity);
        $("#total").text(json.total);

        // Optional: if your backend returns item_subtotal, update it
        if (json.item_subtotal) {
          $("#cart-item-" + productId).find(".item-subtotal").text("$" + json.item_subtotal);
        }
      },
      error: function (xhr) {
        console.error("Error:", xhr.responseText);
      },
    });
  });
</script>
{% endblock %}
