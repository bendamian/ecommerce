{% extends 'base.html' %}
{% load static %}
{% load mathfilters %}

{% block content %}
<main class="pt-5">
  <div class="container">

    <!-- Page Header -->
    <h1 class="h5 mb-3">Shopping Cart</h1>
    <hr>

    <!-- Loop through each item in the cart -->
    {% for item in cart %}
      {% with product=item.product %}  {# Correct syntax for variable assignment #}

      <!-- Product Card -->
      <div class="row mb-4 border rounded product-item py-3 shadow-sm">

        <!-- Product Image -->
        <div class="col-md-3 col-lg-2 bg-light d-flex align-items-center justify-content-center">
          <img 
            src="{{ product.image.url|default:'/static/images/placeholder.png' }}" 
            alt="{{ product.title }}" 
            class="img-fluid rounded"
            width="200"
          >
        </div>

        <!-- Product Details -->
        <div class="col-md-9 col-lg-10 ps-md-4">

          <!-- Product Title -->
          <a href="{{ product.get_absolute_url }}"  class="link-dark link-offset-2 link-underline-opacity-0 link-underline-opacity-75-hover fw-semibold">
            <h2 class="h6 pt-2">{{ item.product.name }}</h2>
          </a>

          <!-- Product Info Box -->
          <div class="border rounded-3 overflow-hidden">

            <!-- Price Row -->
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
              <span>Price</span>
              <span class="fw-bold h6 mb-0">${{ product.price| mul:item.quantity|floatformat:2}}</span>
            </div>

            <!-- Quantity and Buttons -->
            <div class="p-4">

              <label for="qty-{{ item.id }}" class="form-label mb-1"> Qty: </label>

              <select id="select{{ product.id }}" class="form-select form-select-sm d-inline-block w-auto">

                <option selected> {{ item.quantity }} </option>
                <option> 1 </option>
                <option> 2 </option>
                <option> 3 </option>
                <option>4 </option>
              </select>

              <!-- Action Buttons -->
              <div class="mt-3">
                <button type="button"  data-index="{{ product.id }}" class="btn btn-primary btn-sm me-2 btn-update">Update</button>
                <button type="button" data-index="{{ product.id }}" class="btn btn-danger btn-sm btn-delete">Delete</button>
              </div>

            </div>
          </div>
        </div>
      </div>

      {% endwith %}
    {% empty %}
      <p class="text-muted">Your cart is empty.</p>
    {% endfor %}
    </br>
    </br>
    <hr>
    <!-- Subtotal Section -->
    <div class="text-end mt-4">
      <div class="h6 fw-bold">
        Subtotal: $<span id="total">{{ cart.get_total_price | floatformat:2 }}</span>
      </div>
    </div>

  </div>
</main>

<!-- Local script block -->
<script>

  // Remove from cart
  $(document).on('click', '.btn-delete', function(e) {
  e.preventDefault();

  const productId = $(this).data('index');   // ✅ safe
  

  $.ajax({
    type: 'POST',
    url: '{% url "cart_app:cart_remove" %}',
    data: {
      productid: productId,
      csrfmiddlewaretoken: '{{ csrf_token }}',
      action: 'post'
    },
    success: function(json) {
      //console.log('Added to cart:', json);
      document.getElementById('cart-quantity').textContent = json.quantity;
      document.getElementById('total').textContent = json.total;
      
    },
    error: function(xhr, errmsg, err) {
      console.error("Error:", errmsg, xhr.responseText);
    }
  });
});


// Update quantity
$(document).on('click', '.btn-update', function(e) {
  e.preventDefault();

  const productId = $(this).data('index');
  const qty = $("#select" + productId).val();    // MUST match correct HTML id

  $.ajax({
    type: 'POST',
    url: '{% url "cart_app:cart_update" %}',
    data: {
      productid: productId,
      quantity: qty,   // ✅ correct field name
      csrfmiddlewaretoken: '{{ csrf_token }}',
      action: 'post'
    },
    success: function(json) {
      document.getElementById('cart-quantity').textContent = json.quantity;
      document.getElementById('total').textContent = json.total;
    },
    error: function(xhr, errmsg, err) {
      console.error("Error:", xhr.responseText);
    }
  });
});






</script>



<!-- Local style block -->
<style>
main {
  background-color: #f9fafb;
  min-height: 100vh;
}

.product-item {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.product-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

h1, h2, .fw-bold {
  color: #333;
}



.btn-sm {
  border-radius: 20px;
}

#total {
  color: #0d6efd;
}
</style>

{% endblock %}
