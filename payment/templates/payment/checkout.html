{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
  .checkout-page {
    background: #f1f3f5;
    min-height: calc(100vh - 120px);
    padding: 2rem 0;
  }
  .checkout-card {
    max-width: 560px;
    border-radius: 18px;
  }
</style>

<div class="checkout-page">
  <div class="container">
    <div class="card checkout-card shadow-sm border-0 mx-auto">
      <div class="card-body p-4 p-md-5">

        <div class="mb-4">
          <h3 class="fw-bold mb-1">
            <i class="fa fa-chevron-circle-right" aria-hidden="true"></i>
            <span class="ms-2">Complete your order</span>
          </h3>
          <p class="text-muted mb-0">Please enter the relevant information below.</p>
        </div>

        <hr class="my-4">

        <form id="checkout-form" method="POST" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label for="name" class="form-label">Full name <span class="text-danger">*</span></label>
            <input
              class="form-control validate"
              id="name"
              name="full_name"
              type="text"
              placeholder="e.g. Daniya Edward"
              autocomplete="name"
              value="{{ shipping.full_name|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email address <span class="text-danger">*</span></label>
            <input
              class="form-control validate"
              id="email"
              name="email"
              type="email"
              placeholder="e.g. daniya@email.com"
              autocomplete="email"
              value="{{ shipping.email|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="address1" class="form-label">Address line 1 <span class="text-danger">*</span></label>
            <input
              class="form-control validate"
              id="address1"
              name="address_line1"
              type="text"
              placeholder="House/Flat number and street"
              autocomplete="address-line1"
              value="{{ shipping.address_line1|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="address2" class="form-label">Address line 2 (optional)</label>
            <input
              class="form-control"
              id="address2"
              name="address_line2"
              type="text"
              placeholder="Apartment, suite, unit, etc."
              autocomplete="address-line2"
              value="{{ shipping.address_line2|default:'' }}"
            >
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="city" class="form-label">City <span class="text-danger">*</span></label>
              <input
                class="form-control validate"
                id="city"
                name="city"
                type="text"
                placeholder="e.g. London"
                autocomplete="address-level2"
                value="{{ shipping.city|default:'' }}"
                required
              >
            </div>

            <div class="col-md-6">
              <label for="county" class="form-label">County/State (optional)</label>
              <input
                class="form-control"
                id="county"
                name="county"
                type="text"
                placeholder="e.g. Surrey"
                autocomplete="address-level1"
                value="{{ shipping.county|default:'' }}"
              >
            </div>

            <div class="col-md-6">
              <label for="postal_code" class="form-label">Postcode/Zip (optional)</label>

             <input
                class="form-control"
                id="postal_code"
                name="postal_code"
                type="text"
                placeholder="e.g. SM2 5GP"
                autocomplete="postal-code"
                value="{{ shipping.postal_code|default:'' }}"
              >
            </div>
          </div>
         <!--
          <button
            id="complete-order"
            type="submit"
            class="btn btn-primary w-100 mt-4 py-2 fw-semibold"
          >
            Complete order
          </button>
                -->
          <br> 
          <!-- PayPal button  -->
          <div id="paypal-button-container"></div>

   

          


          <p class="text-muted small mt-3 mb-0">
            By placing your order, you agree to our terms and conditions.
          </p>

        </form>
              

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<!-- Load PayPal SDK (best outside the form) -->
<script src="https://www.paypal.com/sdk/js?client-id=AcTAGhkhnrSkxwLU1_EbpR2Yvrrn_buD9THhOmWJwO1FIkrdfiy5frsrmY4mk3uOpg48X2rGktYxoQHQ&currency=USD&intent=capture&enable-funding=venmo"></script>

<script>
  // Total price from Django (string "10.00")
  const total_price = "{{ cart.get_total_price|floatformat:2 }}".replace(",", ".");

  // Stop normal form submission (PayPal will handle checkout)
  document.getElementById("checkout-form").addEventListener("submit", function(e){
    e.preventDefault();
  });

  const paypalButtonsComponent = paypal.Buttons({
    style: {
      color: "silver",
      shape: "pill",
      layout: "vertical"
    },

    onInit: function (data, actions) {
      actions.disable();

      const form = document.getElementById("checkout-form");
      const requiredInputs = form.querySelectorAll("[required]");

      const validateForm = () => {
        let valid = true;

        requiredInputs.forEach(input => {
          if (!input.value.trim() || !input.checkValidity()) {
            input.classList.add("is-invalid");
            valid = false;
          } else {
            input.classList.remove("is-invalid");
          }
        });

        valid ? actions.enable() : actions.disable();
      };

      // Run once on load (helps if browser autofills)
      validateForm();

      // Run again shortly after in case autofill happens late
      setTimeout(validateForm, 200);

      requiredInputs.forEach(input => {
        input.addEventListener("input", validateForm);
        input.addEventListener("change", validateForm);
        input.addEventListener("blur", validateForm);
      });
    },

    createOrder: (data, actions) => {
      if (!total_price || isNaN(Number(total_price))) {
        console.error("Invalid total price:", total_price);
        throw new Error("Invalid total price");
      }

      return actions.order.create({
        purchase_units: [{
          amount: {
            currency_code: "USD",
            value: total_price
          }
        }]
      });
    },

    onApprove: (data, actions) => {
      return actions.order.capture().then(function(details) {
        console.log("Transaction completed", details);

        
      });
    },

    onError: (err) => {
      console.error("PayPal checkout error:", err);
     
    }
  });

  paypalButtonsComponent.render("#paypal-button-container");
</script>







{% endblock scripts %}
