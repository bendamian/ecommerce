{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
  .checkout-page {
    background: #f1f3f5;
    min-height: calc(100vh - 120px);
    padding: 2rem 0;
  }
  .checkout-card {
    max-width: 560px;
    border-radius: 18px;
  }
</style>

<div class="checkout-page">
  <div class="container">
    <div class="card checkout-card shadow-sm border-0 mx-auto">
      <div class="card-body p-4 p-md-5">

        <div class="mb-4">
          <h3 class="fw-bold mb-1">
            <i class="fa fa-chevron-circle-right" aria-hidden="true"></i>
            <span class="ms-2">Complete your order</span>
          </h3>
          <p class="text-muted mb-0">Please enter the relevant information below.</p>
        </div>

        <hr class="my-4">

        <form id="checkout-form" method="post" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label for="name" class="form-label">Full name <span class="text-danger">*</span></label>
            <input
              class="form-control"
              id="name"
              name="full_name"
              type="text"
              placeholder="e.g. Daniya Edward"
              autocomplete="name"
              value="{{ shipping.full_name|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email address <span class="text-danger">*</span></label>
            <input
              class="form-control"
              id="email"
              name="email"
              type="email"
              placeholder="e.g. daniya@email.com"
              autocomplete="email"
              value="{{ shipping.email|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="address1" class="form-label">Address line 1 <span class="text-danger">*</span></label>
            <input
              class="form-control"
              id="address1"
              name="address_line1"
              type="text"
              placeholder="House/Flat number and street"
              autocomplete="address-line1"
              value="{{ shipping.address_line1|default:'' }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="address2" class="form-label">Address line 2 (optional)</label>
            <input
              class="form-control"
              id="address2"
              name="address_line2"
              type="text"
              placeholder="Apartment, suite, unit, etc."
              autocomplete="address-line2"
              value="{{ shipping.address_line2|default:'' }}"
            >
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="city" class="form-label">City <span class="text-danger">*</span></label>
              <input
                class="form-control"
                id="city"
                name="city"
                type="text"
                placeholder="e.g. London"
                autocomplete="address-level2"
                value="{{ shipping.city|default:'' }}"
                required
              >
            </div>

            <div class="col-md-6">
              <label for="state" class="form-label">County/State (optional)</label>
              <input
                class="form-control"
                id="county"
                name="county"
                type="text"
                placeholder="e.g. Surrey"
                autocomplete="address-level1"
                value="{{ shipping.county|default:'' }}"
              >
            </div>

            <div class="col-md-6">
              <label for="zipcode" class="form-label">Postcode/Zip (optional)</label>
              <input
                class="form-control"
                id="postal_code"
                name="postal_code"
                type="text"
                placeholder="e.g. SM2 5GP"
                autocomplete="postal-code"
                value="{{ shipping.postal_code|default:'' }}"
              >
            </div>
          </div>

          <button
            id="complete-order"
            type="submit"
            class="btn btn-primary w-100 mt-4 py-2 fw-semibold"
          >
            Complete order
          </button>

          <p class="text-muted small mt-3 mb-0">
            By placing your order, you agree to our terms and conditions.
          </p>

        </form>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Complete order (AJAX)

  $(function () {
    
    $("#checkout-form").on("submit", function (e) {
      e.preventDefault();
       const fullName = ($('input[name="full_name"]').val() || $('#name').val() || '').trim();
                         if (!fullName) { alert("Enter your full name"); return; }        
      const email = ($("#email").val() || "").trim();
      const address1 = ($("#address1").val() || "").trim();
      const address2 = ($("#address2").val() || "").trim();
      const city = ($("#city").val() || "").trim();
      const county = ($("#county").val() || "").trim();
      const postcode = ($("#postal_code").val() || "").trim();

      // Frontend validation (prevents NULL full_name)
      if (!fullName) {
        alert("Please enter your full name.");
        return;
      }

      $.ajax({
        type: "POST",
        url: '{% url "payment_app:complete-order" %}',
        data: {
          full_name: fullName,
          email: email,
          address_line1: address1,
          address_line2: address2,
          city: city,
          county: county,
          postal_code: postcode,
          csrfmiddlewaretoken: "{{ csrf_token }}",
          action: "post"
        },
        success: function (json) {
          window.location.replace("{% url 'payment_app:payment-success' %}");
        },
        error: function (xhr) {
          console.log("Order failed:", xhr.status, xhr.responseText);

          // Optional: show backend error message if you return JSON errors
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.error) alert(data.error);
          } catch (e) {}

          window.location.replace("{% url 'payment_app:payment-failed' %}");
        }
      });
    });
  });
</script>
{% endblock scripts %}
