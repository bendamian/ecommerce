{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- ======================================================
     CHECKOUT PAGE STYLING
     Keeps layout centered and visually clean
====================================================== -->
<style>
  .checkout-page {
    background: #f1f3f5;
    min-height: calc(100vh - 120px);
    padding: 2rem 0;
  }
  .checkout-card {
    max-width: 560px;
    border-radius: 18px;
  }
</style>

<!-- ======================================================
     CHECKOUT FORM CONTAINER
====================================================== -->
<div class="checkout-page">
  <div class="container">
    <div class="card checkout-card shadow-sm border-0 mx-auto">
      <div class="card-body p-4 p-md-5">

        <!-- Page Heading -->
        <div class="mb-4">
          <h3 class="fw-bold mb-1">
            <i class="fa fa-chevron-circle-right" aria-hidden="true"></i>
            <span class="ms-2">Complete your order</span>
          </h3>
          <p class="text-muted mb-0">
            Please enter your shipping and contact details below.
          </p>
        </div>

        <hr class="my-4">

        <!-- ======================================================
             CHECKOUT FORM (Validated before PayPal enabled)
        ====================================================== -->
        <form id="checkout-form" method="POST" novalidate>
          {% csrf_token %}

          <!-- Full Name -->
          <div class="mb-3">
            <label for="name" class="form-label">
              Full name <span class="text-danger">*</span>
            </label>
            <input
              class="form-control validate"
              id="name"
              name="full_name"
              type="text"
              placeholder="e.g. Daniya Edward"
              autocomplete="name"
              value="{{ shipping.full_name|default:'' }}"
              required
            >
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label">
              Email address <span class="text-danger">*</span>
            </label>
            <input
              class="form-control validate"
              id="email"
              name="email"
              type="email"
              placeholder="e.g. daniya@email.com"
              autocomplete="email"
              value="{{ shipping.email|default:'' }}"
              required
            >
          </div>

          <!-- Address Line 1 -->
          <div class="mb-3">
            <label for="address1" class="form-label">
              Address line 1 <span class="text-danger">*</span>
            </label>
            <input
              class="form-control validate"
              id="address1"
              name="address_line1"
              type="text"
              placeholder="House/Flat number and street"
              autocomplete="address-line1"
              value="{{ shipping.address_line1|default:'' }}"
              required
            >
          </div>

          <!-- Address Line 2 (Optional) -->
          <div class="mb-3">
            <label for="address2" class="form-label">
              Address line 2 (optional)
            </label>
            <input
              class="form-control"
              id="address2"
              name="address_line2"
              type="text"
              placeholder="Apartment, suite, unit, etc."
              autocomplete="address-line2"
              value="{{ shipping.address_line2|default:'' }}"
            >
          </div>

          <!-- City / County / Postcode -->
          <div class="row g-3">
            <div class="col-md-6">
              <label for="city" class="form-label">
                City <span class="text-danger">*</span>
              </label>
              <input
                class="form-control validate"
                id="city"
                name="city"
                type="text"
                autocomplete="address-level2"
                value="{{ shipping.city|default:'' }}"
                required
              >
            </div>

            <div class="col-md-6">
              <label for="county" class="form-label">
                County/State (optional)
              </label>
              <input
                class="form-control"
                id="county"
                name="county"
                type="text"
                autocomplete="address-level1"
                value="{{ shipping.county|default:'' }}"
              >
            </div>

            <div class="col-md-6">
              <label for="postal_code" class="form-label">
                Postcode/Zip
              </label>
              <input
                class="form-control"
                id="postal_code"
                name="postal_code"
                type="text"
                autocomplete="postal-code"
                value="{{ shipping.postal_code|default:'' }}"
              >
            </div>
          </div>

          <!-- PayPal Button Container -->
          <br>
          <div id="paypal-button-container"></div>

          <p class="text-muted small mt-3 mb-0">
            By placing your order, you agree to our terms and conditions.
          </p>

        </form>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<!-- ======================================================
     LOAD PAYPAL SDK
     Client ID should ideally be injected from settings
====================================================== -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD&intent=capture"></script>

<script>
  // ======================================================
  // PREVENT DEFAULT FORM SUBMISSION
  // PayPal button controls the checkout flow
  // ======================================================
  document.getElementById("checkout-form").addEventListener("submit", function(e){
    e.preventDefault();
  });

  // Total cart price passed from Django
  const total_price = "{{ cart.get_total_price|floatformat:2 }}".replace(",", ".");

  // ======================================================
  // PAYPAL BUTTON CONFIGURATION
  // ======================================================
  const paypalButtonsComponent = paypal.Buttons({

    style: {
      color: "silver",
      shape: "pill",
      layout: "vertical"
    },

    // --------------------------------------------------
    // Enable PayPal button only when required fields valid
    // --------------------------------------------------
    onInit: function (data, actions) {
      actions.disable();

      const form = document.getElementById("checkout-form");
      const requiredInputs = form.querySelectorAll("[required]");

      const validateForm = () => {
        let valid = true;

        requiredInputs.forEach(input => {
          if (!input.value.trim() || !input.checkValidity()) {
            input.classList.add("is-invalid");
            valid = false;
          } else {
            input.classList.remove("is-invalid");
          }
        });

        valid ? actions.enable() : actions.disable();
      };

      validateForm();
      setTimeout(validateForm, 200);

      requiredInputs.forEach(input => {
        input.addEventListener("input", validateForm);
        input.addEventListener("change", validateForm);
        input.addEventListener("blur", validateForm);
      });
    },

    // --------------------------------------------------
    // Create PayPal Order
    // --------------------------------------------------
    createOrder: (data, actions) => {
      return actions.order.create({
        purchase_units: [{
          amount: {
            currency_code: "USD",
            value: total_price
          }
        }]
      });
    },

    // --------------------------------------------------
    // On Payment Approval
    // Capture payment, then send order to Django
    // --------------------------------------------------
    onApprove: (data, actions) => {
      return actions.order.capture().then(function (details) {

        const paypalOrderId = data.orderID;
        const captureId =
          details?.purchase_units?.[0]?.payments?.captures?.[0]?.id || null;

        // Send order data to Django backend
        return $.ajax({
          type: "POST",
          url: '{% url "payment_app:complete-order" %}',
          data: {
            action: "post",
            full_name: $("#name").val(),
            email: $("#email").val(),
            address_line1: $("#address1").val(),
            address_line2: $("#address2").val(),
            city: $("#city").val(),
            county: $("#county").val(),
            postal_code: $("#postal_code").val(),
            paypal_order_id: paypalOrderId,
            paypal_capture_id: captureId,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function () {
            window.location.replace("{% url 'payment_app:payment-success' %}");
          },
          error: function () {
            window.location.replace("{% url 'payment_app:payment-failed' %}");
          }
        });
      });
    },

    // --------------------------------------------------
    // Handle PayPal errors
    // --------------------------------------------------
    onError: (err) => {
      console.error("PayPal checkout error:", err);
    }

  });

  paypalButtonsComponent.render("#paypal-button-container");

</script>

{% endblock scripts %}
